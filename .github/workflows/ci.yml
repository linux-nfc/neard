# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2021 Canonical Ltd.
# Author: Krzysztof Kozlowski <krzysztof.kozlowski@canonical.com>
#                             <krzk@kernel.org>
# Loosely based on https://github.com/linux-test-project/ltp
#
name: "Builds"
on: [push, pull_request]

jobs:
  job:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu gcc
          - container: "ubuntu:hirsute"
            env:
              CC: gcc
              MODE: maintainer

          - container: "ubuntu:hirsute"
            env:
              ARCH: x86-64
              CC: gcc
              MODE: no-maintainer

          - container: "ubuntu:focal"
            env:
              CC: gcc
              MODE: maintainer

          - container: "ubuntu:focal"
            env:
              CC: gcc
              MODE: no-maintainer

          - container: "ubuntu:bionic"
            env:
              CC: gcc
              MODE: maintainer

          - container: "ubuntu:xenial"
            env:
              CC: gcc
              MODE: maintainer

          # Ubuntu clang
          - container: "ubuntu:hirsute"
            env:
              CC: clang
              MODE: maintainer

          - container: "ubuntu:focal"
            env:
              CC: clang
              MODE: maintainer

          - container: "ubuntu:focal"
            env:
              CC: clang
              MODE: no-maintainer

    container:
      image: ${{ matrix.container }}
      env: ${{ matrix.env }}

    steps:
    - name: Show OS
      run: cat /etc/os-release

    - name: Git checkout
      uses: actions/checkout@v2

    - name: Install additional packages
      run: |
        INSTALL=${{ matrix.container }}
        INSTALL="${INSTALL%%:*}"
        INSTALL="${INSTALL%%/*}"
        ./ci/$INSTALL.sh
        if [ "$VARIANT" ]; then ./ci/$INSTALL.$VARIANT.sh; fi

    - name: Compiler version
      run: $CC --version

    - name: Display environment and Linux version
      run: |
        test -f /etc/issue && cat /etc/issue
        lsb_release -a || true
        uname -a
        cat /proc/cmdline
        printenv

    - name: Configure
      run: |
        echo "Bootstraping in mode: $MODE"
        if [ "$MODE" = "maintainer" ]; then
          ./bootstrap-configure \
            --disable-silent-rules
        else
          ./bootstrap && \
            ./configure \
            --disable-systemd \
            --disable-silent-rules \
            --prefix=/usr \
            --enable-ese \
            --sysconfdir=/etc \
            --enable-tools
        fi

    - name: Compile
      run: make -j$(nproc)

    - name: Install
      run: make install

    - name: Distribution check
      run: make distcheck
